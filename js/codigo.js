// const de productos
const stockProductos = [{
        id: 1,
        nombre: "Tradicionales x 60g",
        precio: 128,
        img:
            "./assets/img/papastradicionales.png",
        cantidad: 1
    },
    {
        id: 2,
        nombre: "Jamon Serrano x 55g",
        precio: 140,
        img:
            "./assets/img/jamonserrano.png",
        cantidad: 1
    },
    {
        id: 3,
        nombre: "Corte Americano x 60g",
        precio: 128,
        img:
            "./assets/img/corteamericano.png",
        cantidad: 1
    },
    {
        id: 4,
        nombre: "Cheddar x 55g",
        precio: 140,
        img:
            "./assets/img/cheddar.png",
        cantidad: 1
    },
    {
        id: 5,
        nombre: "Ketchup x 55g",
        precio: 140,
        img:
            "./assets/img/ketchup.png",
        cantidad: 1
    },
    {
        id: 6,
        nombre: "Pay x 65g",
        precio: 128,
        img:
            "./assets/img/pay.png",
        cantidad: 1
    },
    {
        id: 7,
        nombre: "Papas sin sal x 60g",
        precio: 128,
        img:
            "./assets/img/sinsal.png",
        cantidad: 1
    },
    {
        id: 8,
        nombre: "Palitos Maiz Queso x 65g",
        precio: 110,
        img:
            "./assets/img/chizitos.png",
        cantidad: 1
    },
    {
        id: 9,
        nombre: "Bastonitos x 55g",
        precio: 100,
        img:
            "./assets/img/bastonitoskrachitos.png",
        cantidad: 1    
    },
    {
        id: 10,
        nombre: "Super Conos x 45g",
        precio: 96,
        img:
            "./assets/img/superconos.png",
        cantidad: 1
    },
    {
        id: 11,
        nombre: "Palitos Salados x 65g",
        precio: 92,
        img:
            "./assets/img/palitos.png",
        cantidad: 1
    },
    {
        id: 12,
        nombre: "Palitos queso x 65g",
        precio: 101,
        img:
            "./assets/img/palitosqueso.png",
        cantidad: 1
    },
    {
        id: 13,
        nombre: "Mani Pelado x 65g",
        precio: 120,
        img:
            "./assets/img/manipelado.png",
        cantidad: 1
    },
    {
        id: 14,
        nombre: "Mani Frito x 65g",
        precio: 120,
        img:
            "./assets/img/manifrito.png",
        cantidad: 1
    },
    {
        id: 15,
        nombre: "Café Santos",
        precio: 4400,
        img:
            "./assets/img/santos.png",
        cantidad: 1
    },
    {
        id: 16,
        nombre: "Café Torrado Molido x 500g",
        precio: 835,
        img:
            "./assets/img/molido500.png",
        cantidad: 1
    },
    {
        id: 17,
        nombre: "Café Torrado Molido x 250g",
        precio: 425,
        img:
            "./assets/img/torradox250.png",
        cantidad: 1
    },
    {
        id: 18,
        nombre: "Café en saquitos",
        precio: 408,
        img:
            "./assets/img/saquitos.png",
        cantidad: 1
    },
    {
        id: 19,
        nombre: "Café Tostado Premium",
        precio: 4087,
        img:
            "./assets/img/tostadopremium.png",
        cantidad: 1
    },
    {
        id: 20,
        nombre: "Azúcar",
        precio: 2282,
        img:
            "./assets/img/azucar5h.png",
        cantidad: 1
    },

    {
        id: 21,
        nombre: "Edulcorante",
        precio: 1050,
        img:
            "./assets/img/edulcorante5h.png",
        cantidad: 1
    },
    {
        id: 22,
        nombre: "Nachos x 250g",
        precio: 334,
        img:
            "./assets/img/macritasclasicas.jpg",
        cantidad: 1
    },
    {
        id: 23,
        nombre: "Nachos XXL x 250g",
        precio: 334,
        img:
            "./assets/img/macritasexxtra.jpg",
        cantidad: 1
    },
    {
        id: 24,
        nombre: "Nachos Redondos x 130g",
        precio: 252,
        img:
            "./assets/img/macritasredondas.jpg",
        cantidad: 1
    },
    {
        id: 25,
        nombre: "Nachos x 90g",
        precio: 334,
        img:
            "./assets/img/macritasclasicas.jpg",
        cantidad: 1
    },
    {
        id: 26,
        nombre: "Nachos Queso x 70g",
        precio: 156,
        img:
            "./assets/img/macritasqueso.jpg",
        cantidad: 1
    },
    {
        id: 27,
        nombre: "Nachos Ketchup x 70g",
        precio: 156,
        img:
            "./assets/img/macritasketchup.jpg",
        cantidad: 1
    },
    {
        id: 28,
        nombre: "Nachos Queso y Jalapeño  x 70g",
        precio: 156,
        img:
            "./assets/img/macritasjalapeño.jpg",
        cantidad: 1
    },
    {
        id: 29,
        nombre: "Nachos Multicereal x 90g",
        precio: 158,
        img:
            "./assets/img/macritasmulticereal.jpg",
        cantidad: 1
    },
    {
        id: 30,
        nombre: "Chocolate x 53g",
        precio: 85,
        img:
            "./assets/img/minichoco.jpg",
        cantidad: 1
    },
    {
        id: 31,
        nombre: "Caramel x 53g",
        precio: 85,
        img:
            "./assets/img/minicaramel.jpg",
        cantidad: 1
    },
    {
        id: 32,
        nombre: "Finas hierbas x 53g",
        precio: 85,
        img:
            "./assets/img/minifinas.jpg",
        cantidad: 1
    },
    {
        id: 33,
        nombre: "Queso Romano x 53g",
        precio: 85,
        img:
            "./assets/img/miniqueso.jpg",
        cantidad: 1
    },
    {
        id: 34,
        nombre: "Aceite x 1,5l",
        precio: 955,
        img:
            "./assets/img/aceitenatura.png",
        cantidad: 1
    },
    {
        id: 35,
        nombre: "Rocio Vegetal",
        precio: 480,
        img:
            "./assets/img/rociovegetal.png",
        cantidad: 1
    },
    {
        id: 36,
        nombre: "Mayonesa x 250g",
        precio: 253,
        img:
            "./assets/img/mayonesanatura.png",
        cantidad: 1
    },
    {
        id: 37,
        nombre: "Ketchup x 250g",
        precio: 178,
        img:
            "./assets/img/ketchupnatura.png",
        cantidad: 1
    },
    {
        id: 38,
        nombre: "Mostaza x 250g",
        precio: 133,
        img:
            "./assets/img/mostazanatura.png",
        cantidad: 1
    },
    {
        id: 39,
        nombre: "Salsa golf x 250g",
        precio: 167,
        img:
            "./assets/img/salsagolfnatura.png",
        cantidad: 1
    },
    {
        id: 40,
        nombre: "Mani Crocante Original x 1 kg",
        precio: 470,
        img:
            "./assets/img/crisjorsalado.png",
        cantidad: 1
    },
    {
        id: 41,
        nombre: "Mani Crocante Pizza x 1kg",
        precio: 470,
        img:
            "./assets/img/crisjorpizza.png",
        cantidad: 1
    },
    {
        id: 42,
        nombre: "Mani Crocante Mortadela x 1kg",
        precio: 470,
        img:
            "./assets/img/crisjormortadela.png",
        cantidad: 1
    },
    {
        id: 43,
        nombre: "Mani Crocante Provenzal x 1kg",
        precio: 470,
        img:
            "./assets/img/crisjorprovenzal.png",
        cantidad: 1
    },
    {
        id: 44,
        nombre: "Mani Crocante Jamon x 1 kg",
        precio: 470,
        img:
            "./assets/img/jamoncrisjor.png",
        cantidad: 1
    },
    {
        id: 45,
        nombre: "Mani Pelado x 1kg",
        precio: 470,
        img:
            "./assets/img/peladocrisjor.png",
        cantidad: 1
    },
    {
        id: 46,
        nombre: "Mani Pelado sin sal x 1kg",
        precio: 470,
        img:
            "./assets/img/crisjorsinsal.png",
        cantidad: 1
    },
    {
        id: 47,
        nombre: "Mani Frito x 1kg",
        precio: 470,
        img:
            "./assets/img/crisjorfrito.png",
        cantidad: 1
    },
    {
        id: 48,
        nombre: "Sal fina  x 2 gr",
        precio: 1253,
        img:
            "./assets/img/salinysa.png",
        cantidad: 1
    },
    {
        id: 49,
        nombre: "Limón x 8cc",
        precio: 1498,
        img:
            "./assets/img/limoninysa.png",
        cantidad: 1
    },
    {
        id: 50,
        nombre: "Aceite maiz x 8cc",
        precio: 2320,
        img:
            "./assets/img/aceiteinysa.png",
        cantidad: 1
    },
    {
        id: 51,
        nombre: "Aceto balsamico x 8cc",
        precio: 1745,
        img:
            "./assets/img/acetoinysa.png",
        cantidad: 1
    },
    {
        id: 52,
        nombre: "Vinagre x 8cc",
        precio: 1745,
        img:
            "./assets/img/vinagreinysa.png",
        cantidad: 1
    },
    {
        id: 53,
        nombre: "Edulcorante x 0,8 gr",
        precio: 1745,
        img:
            "./assets/img/edulcoranteinysa.png",
        cantidad: 1
    },
    {
        id: 54,
        nombre: "Azúcar x 6,25 gr",
        precio: 1745,
        img:
            "./assets/img/azucarinysa.png",
        cantidad: 1
    },
    {
        id: 55,
        nombre: "Aceite oliva x 8cc",
        precio: 1745,
        img:
            "./assets/img/olivainysa.png",
        cantidad: 1
    },
    {
        id: 56,
        nombre: "Pay x 500g",
        precio: 550,
        img:
            "./assets/img/pay500.png",
        cantidad: 1
    },
    {
        id: 57,
        nombre: "Pay x 900g",
        precio: 814,
        img:
            "./assets/img/pay900.png",
        cantidad: 1
    }
];

// declaro variable para el almacenamiento del carrito
let carrito = [];
// declaro const para crear contenido del carrito
const contenedor = document.querySelector("#contenedor");
const carritoContenedor = document.querySelector("#carritoContenedor");
const vaciarCarrito = document.querySelector("#vaciarCarrito");
const precioTotal = document.querySelector("#precioTotal");
const activarFuncion = document.querySelector("#activarFuncion");
const procesarCompra = document.querySelector("#procesarCompra");
const totalProceso = document.querySelector("#totalProceso");
const formulario = document.querySelector("#procesar-pago");



// evento para activar funcion y lograr ver los detalles de productos precios etc en compra.html
if (activarFuncion) {
    activarFuncion.addEventListener("click", procesarPedido);
}
// evento cuando el usuario ingrese a la pagina, si quedo algun carrito pasado quede guardado en local storage 
document.addEventListener("DOMContentLoaded", () => {
    carrito = JSON.parse(localStorage.getItem("carrito")) || [];

    mostrarCarrito();
    if(activarFuncion){
        document.querySelector("#activarFuncion").click(procesarPedido);
    }
    
    });

    // evento para enviar formulario a email js
if (formulario) {
    formulario.addEventListener("submit", enviarCompra);
}

// evento de boton "vaciar carrito"
if (vaciarCarrito) {
    vaciarCarrito.addEventListener("click", () => {
        carrito.length = [];
        mostrarCarrito();
    });
}

// evento y sweet alert para boton continuar compra.html o avisar de que no se agregaron productos al carrito
if (procesarCompra) {
    procesarCompra.addEventListener("click", () => {
        if (carrito.length === 0) {
            Swal.fire({
                title: "¡Tu carrito está vacio!",
                text: "Compra algo para continuar con la compra",
                icon: "error",
                confirmButtonText: "Aceptar",
            });
        } else {
            location.href = "./pages/compra.html";
        }
    });
}
// ciclo for each de productos + creo cards para mostrar mis productos en index.html
stockProductos.forEach((prod) => {
    const {
        id,
        nombre,
        precio,
        img,
    } = prod;
    if (contenedor) {
        contenedor.innerHTML += `
    <div class="card col-sm-12 col-md-6 col-lg-3" data-aos="zoom-in-left">
        <img class="card-img-top krach" src="${img}" alt="Card image cap">
        <div class="card-body">
            <h5 class="card-title">${nombre}</h5>
            <p class="card-text">Precio: ${precio.toFixed(2)}</p>
            <button class="btn btn-primary" onclick="agregarProducto(${id})">Comprar Producto</button>
        </div>
    </div>
    `;
    }
});

// funcion para agregar productos al carrito
const agregarProducto = (id) => {
    const existe = carrito.some((prod) => prod.id === id);
    
    if (existe) {
        const prod = carrito.map((prod) => {
            if (prod.id === id) {
                
                prod.cantidad++
                Swal.fire({
                    title: prod.nombre.toUpperCase(),
                    imageAlt: prod.nombre,
                    imageWidth: 250,
                    imageHeight: 320,
                    imageUrl: `${prod.img}`,
                    text: "Se agregó al carrito",
                    color: `#1df8b2`,
                    width: 600,
                    showConfirmButton: false,
                    timer: 1500,
                    background: `#005899`,
                    showClass: {
                        popup: "animate__animated animate__jackInTheBox",
                    },
                    hideClass: {
                        popup: "animate__animated animate__backOutDown",
                    },
                });
                
            }
        });
    } else {
        const item = stockProductos.find((prod) => prod.id === id);
        carrito.push(item);
    }
    mostrarCarrito();
};

// creo modal del carrito
const mostrarCarrito = () => {
    const modalBody = document.querySelector(".modal .modal-body");
    if (modalBody) {
        modalBody.innerHTML = "";
        carrito.forEach((prod) => {
            const {
                id,
                nombre,
                precio,
                img,
                cantidad
            } = prod;

            modalBody.innerHTML += `
        <div class="modal-contenedor">
            <div>
                <img class="img-fluid img-carrito" src="${img}"/>
            </div>
            <div>
                <p>Producto: ${nombre}</p>
                <p>Precio: ${precio}</p>
                <span class="restar">-</span>
                <p>Cantidad :${cantidad}</p>
                <span class="sumar">+</span>
                <button class="btn btn-danger"  onclick="eliminarProducto(${id})">Eliminar producto</button>
            </div>
        </div>
        `;
        // variable y evento para boton restar cantidades
        let restar = modalBody.querySelector(".restar");
    
            restar.addEventListener("click", () =>{
                if (prod.cantidad !== 1){
                    prod.cantidad--;
                }
                guardarStorage();
                mostrarCarrito();
                }) 
            
    // variable y evento para boton sumar cantidades
            let sumar = modalBody.querySelector(".sumar");
    
            sumar.addEventListener("click", () =>{
                prod.cantidad++;
                guardarStorage();
                mostrarCarrito();
            }) 
        });
    }

    // si el carrito queda vacio aviso de que no agrego ningun producto
    if (carrito.length === 0) {
        modalBody.innerHTML = `
        <p class="text-center text-primary parrafo">¡Aun no agregaste nada!</p>
        `;
    }
    carritoContenedor.textContent = carrito.length;

    // calculo de cantidad de productos por precio
    if (precioTotal) {
        precioTotal.innerText = carrito.reduce(
            (acc, prod) => acc + prod.cantidad * prod.precio,
            0
        );
    }    
    guardarStorage();
};

//  funcion para guardar local storage
function guardarStorage() {
    localStorage.setItem("carrito", JSON.stringify(carrito));
}

// funcion para eliminar productos
function eliminarProducto(id) {
    const productosId = id;
    carrito = carrito.filter((productos) => productos.id !== productosId);
    mostrarCarrito();
}

// creo funcion para procesar pedido y tabla para la pagina de compra.html
function procesarPedido() {
    carrito.forEach((prod) => {
        const listaCompra = document.querySelector("#lista-compra tbody");
        const {
            id, nombre, precio, img, cantidad} = prod;
        if (listaCompra) {
            const row = document.createElement("tr");
            row.innerHTML += `
                <td>
                    <img class="img-fluid img-carrito" src="${img}"/>
                </td>
                <td>${nombre}</td>
                <td>$${precio}</td>
                <td>${cantidad}</td>
                <td>$${precio * cantidad}</td>
                `;
            listaCompra.appendChild(row);
        }
    });

    totalProceso.innerText = carrito.reduce(
        (acc, prod) => acc + prod.cantidad * prod.precio, 0
    );
}

// creo funcion  y sweet alerts para enviar formulario a email js
function enviarCompra(e) {
    e.preventDefault();
    const persona = document.querySelector("#persona").value;
    const email = document.querySelector("#correo").value;

    if (email === "" || persona == "") {
        Swal.fire({
            title: "¡Debes completar tu email y nombre!",
            text: "Rellena el formulario",
            icon: "error",
            confirmButtonText: "Aceptar",
        });
    } else {
        const btn = document.getElementById("button");

        btn.value = "Enviando...";

        const serviceID = "default_service";
        const templateID = "template_fmk9fth";

        email.sendForm(serviceID, templateID, this).then(
            () => {
                btn.value = "Finalizar compra";
                Swal.fire({
                    title: "Se ha enviado tu compra correctamente",
                    text: "Gracias por tu compra, Atte: MarvarSnacks",
                    icon: "success",
                    confirmButtonText: "Aceptar",
                });;
            },
            (err) => {
                btn.value = "Finalizar compra";
                alert(JSON.stringify(err));
            }
        );

        const spinner = document.querySelector("#spinner");
        spinner.classList.add("d-flex");
        spinner.classList.remove("d-none");

        setTimeout(() => {
            spinner.classList.remove("d-flex");
            spinner.classList.add("d-none");
            formulario.reset();

            const alertExito = document.createElement("p");
            alertExito.classList.add(
                "alert", "alerta", "d-block", "text-center", "col-12", "mt-2", "alert-success"
            );
            alertExito.textContent = "Compra realizada correctamente";
            formulario.appendChild(alertExito);

            setTimeout(() => {
                alertExito.remove();
            }, 3000);
        }, 3000);
    }
    localStorage.clear();
}


